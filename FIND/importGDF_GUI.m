function importGDF_GUI()
% GUI initialization of the importGDF GUI.
%
% Data can be allocated by setting the EntityID. This functionality is 
% optional. No input to this field results in an automatic generation of 
% contioneous IDs starting with EntityID 1. If you want to append imported 
% data to already existing data assign new data by using the same EntityID
% as the old one. 
%
% This function belongs to FIND_GUI Toolbox project
% http://find.bccn.uni-freiburg.de

global nsFile; %-% if needed.

global BUTTON_HEIGHT;
global MESSAGEBAR_PANEL_HEIGHT;
global LABEL_HEIGHT;
global MESSAGEBAR_LEFT_OFFSET;
global MESSAGEBAR_RIGHT_OFFSET;

try
   
    % Check if the importGDF GUI is already open
    if ishandle(findobj('tag', 'importGDF_GUI'))
        close(findobj('tag', 'importGDF_GUI'));
    end;

    % GUI window
    GUIxPos=20;
    GUIyPos=20;
    GUIwidth=70;
    GUIheight=20;
    
    GUIwindow=figure('Units','characters',...
        'Position',[GUIxPos GUIyPos GUIwidth GUIheight], ...
        'Tag','importGDF_GUI', ...
        'Name','Import GDF GUI',...
        'MenuBar','none',...
        'NumberTitle','off',...
        'resize','off');

    % panels
    centralPanel=uipanel('Parent',GUIwindow,...
        'Units','characters',...
        'Position',[0 MESSAGEBAR_PANEL_HEIGHT ...
                    GUIwidth (GUIheight-MESSAGEBAR_PANEL_HEIGHT)],...
        'Tag','importGDF_GUI_centralPanel',...
        'BackgroundColor', [0.8 0.8 0.8]);

    messageBarPanel=uipanel('Parent',GUIwindow,...
        'Units','characters',...
        'Position',[0 0 ...
                    GUIwidth MESSAGEBAR_PANEL_HEIGHT],...
        'Tag','importGDF_GUI_messageBarPanel');

    % message bar
    messageBarPanelPos=get(messageBarPanel,'Position');
    messageBar=uicontrol('Parent',messageBarPanel,...
        'Units','characters',...
        'Position',[(messageBarPanelPos(1)+MESSAGEBAR_LEFT_OFFSET) ...
                    (messageBarPanelPos(2)) ...
                    (messageBarPanelPos(3)-MESSAGEBAR_RIGHT_OFFSET) ...
                    LABEL_HEIGHT],...
        'Tag','importGDF_GUI_messageBarText',...
        'Enable','on',...
        'String','',...
        'HorizontalAlignment','left',...
        'Style','text');

    % button to run the tool
    toolButton=uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[17 15.5 35 BUTTON_HEIGHT],... 
        'Style','pushbutton',...
        'String','choose file',...
        'Tag','importGDF_GUI_importGDFPushbutton',...
        'Enable','on',...
        'Callback',@importGDFPushbuttonCallback); 
          
    
    % field to set EntityIDs of new neural data
    
    % if you want to append data to already existing data use identical IDs
    % if no entityIDs are set they will be generated staring with ID 1
    
    uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[5 13.25 30 LABEL_HEIGHT],...
        'Style','text',...
        'String','set data EntityIDs (optional) : ',...
        'Tag','importGDF_GUI_textNewNeuralEntityIDs',...
        'Enable','on');
    
      uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[38 13.25 25  LABEL_HEIGHT],...
         'Style','edit',...
        'String',[],...
        'Tag','importGDF_GUI_newNeuralEntityIDs',...
        'Enable','on');
        
     % field to set EntityIDs of new event data
     
    uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[5 12 30 LABEL_HEIGHT],...
        'Style','text',...
        'String','set trigger EntityID (optional) : ',...
        'Tag','importGDF_GUI_textNewEventEntityID',...
        'Enable','on');
    
      uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[38 12 25  LABEL_HEIGHT],...
         'Style','edit',...
        'String',[],...
        'Tag','importGDF_GUI_newEventEntityID',...
        'Enable','on');
    
    
      % segment data info listbox
    uicontrol('Parent',centralPanel,...
        'Units','characters',...
        'Position',[12    1   45    10],...
        'Style','ListBox',...
        'String','import Results',...
        'Tag','importGDF_GUI_importedDataListbox',...
        'Enable','on');
    
catch
    % if error occurs here, the window is closed, the error is rethrown
    % and then catched by the main window
    close(findobj('tag', 'importGDF_GUI'));
    rethrow(lasterror);
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function importGDFPushbuttonCallback(source,event) 
% Run tool button callback; starts importGDF.
% Source and event args are generated by default.
global nsFile;

try
    [fileName, pathName] = uigetfile( ...
   {'*.gdf','gdf-files (*.gdf)';
   '*.*',  'All Files (*.*)'}, ...
   'Import data file');
    % redraw figure before going busy, otherwise 'smeared out'
    % by file dialog
    if fileName==0
            return;
    end
    refresh;
    postMessage('Busy - please wait...');
    % grap parameters
    tmpFig=findobj('Tag','importGDF_GUI_newNeuralEntityIDs');
    tmp=get(tmpFig(1),'String');
    newNeuralEntityIDs=str2num(tmp);
    tmpFig2=findobj('Tag','importGDF_GUI_newEventEntityID');
    tmp2=get(tmpFig2(1),'String');
    newEventEntityID=str2num(tmp2);

    % import GDF
    txt_array=importGDF('fileName',[pathName fileName],...
        'newNeuralEntityIDs',newNeuralEntityIDs,'newEventEntityID',newEventEntityID);
    
    % show little report
    txt_array=strvcat(txt_array,' ','imported by using importGDF.m');
    tmp=findobj('Tag','importGDF_GUI_importedDataListbox');
    set(tmp,'String',txt_array);
    
    postMessage('...done.'); 
catch
   handleError(lasterror); 
end
